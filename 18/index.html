<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descubre la Canci√≥n</title>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        .button-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .reveal-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 20px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .reveal-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        .reveal-btn:active {
            transform: translateY(-1px);
        }

        .reveal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .content {
            display: none;
            animation: fadeIn 0.8s ease-in;
        }

        .content.show {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .player-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            text-align: center;
        }

        .album-art {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
        }

        .album-art.show {
            display: block;
        }

        .track-info {
            margin-bottom: 20px;
            display: none;
        }

        .track-info.show {
            display: block;
        }

        .track-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .track-artist {
            font-size: 1.1em;
            color: #666;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        .control-btn {
            background: #1DB954;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .control-btn.play {
            width: 60px;
            height: 60px;
            font-size: 1.5em;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: #1DB954;
            width: 0%;
            transition: width 0.1s linear;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .lyrics-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            line-height: 1.8;
            text-align: center;
            display: none;
            animation: fadeIn 0.8s ease-in;
        }

        .lyrics-box.show {
            display: block;
        }

        .lyrics-box p {
            font-size: 1.1em;
            color: #333;
            font-style: italic;
            margin-bottom: 15px;
        }

        .lyrics-box p:last-child {
            margin-bottom: 0;
        }

        .status {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .lyrics-divider {
            border: none;
            border-top: 3px solid #667eea;
            margin: 30px auto;
            width: 60%;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }
        

        @media (max-width: 600px) {
            .reveal-btn {
                padding: 15px 30px;
                font-size: 1em;
            }

            .lyrics-box {
                padding: 20px;
            }

            .lyrics-box p {
                font-size: 1em;
            }

            .player-container {
                padding: 20px;
            }

            .album-art {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="button-container">
            <button class="reveal-btn" id="loginBtn">üéµ Descubre la Canci√≥n</button>
        </div>

        <div class="status" id="status" style="display: none;"></div>
        
        <div class="content" id="content">
            <div class="player-container">
                <img id="albumArt" class="album-art" src="" alt="Album Art">
                
                <div class="track-info" id="trackInfo">
                    <div class="track-name" id="trackName"></div>
                    <div class="track-artist" id="trackArtist"></div>
                </div>

                <div class="controls">
                    <button class="control-btn" id="prevBtn" title="Anterior">‚èÆ</button>
                    <button class="control-btn play" id="playBtn" title="Reproducir">‚ñ∂</button>
                    <button class="control-btn" id="nextBtn" title="Siguiente">‚è≠</button>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-time">
                        <span id="currentTime">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
            </div>

            <div class="lyrics-box" id="lyricsBox">
                <p>I can't stop this feelin' deep inside of me</p>
                <p>Girl, you just don't realize what you do to me</p>
                <p>When you hold me in your arms so tight</p>
                <p>You let me know everything's alright</p>
                <p>I, I'm hooked on a feeling, high on believin'</p>
                <p>That you're in love with me</p>
                <hr class="lyrics-divider">
                <p>No puedo detener este sentimiento tan profundo dentro de m√≠,</p>
                <p>chica, no te das cuenta de lo que me haces sentir.</p>
                <p>Cuando me abrazas tan fuerte,</p>
                <p>me haces saber que todo est√° bien.</p>
                <p>Estoy enganchado a un sentimiento, euf√≥rico al creer</p>
                <p>que est√°s enamorada de m√≠.</p>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = 'b8b6b8bdbe6a48a38ff1e42dee25aa81';
        const REDIRECT_URI = 'https://tamarit-personal.github.io/adviento-elena/18/';
        const TRACK_URI = 'spotify:track:5P6t1QIImaKAyphhE1QiY7'; 
        
        let player;
        let deviceId;
        let isPlaying = false;
        let currentPosition = 0;
        let duration = 0;
        let positionInterval;
        let lyricsShown = false;
        let accessToken = null;

        // Funciones PKCE
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return values.reduce((acc, x) => acc + possible[x % possible.length], "");
        }

        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        function base64encode(input) {
            return btoa(String.fromCharCode(...new Uint8Array(input)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        async function generateCodeChallenge(codeVerifier) {
            const hashed = await sha256(codeVerifier);
            return base64encode(hashed);
        }

        // Funci√≥n para obtener par√°metros de la URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                code: params.get('code'),
                error: params.get('error')
            };
        }

        // Funci√≥n para formatear tiempo
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Inicializar cuando se carga el script de Spotify
        window.onSpotifyWebPlaybackSDKReady = () => {
            if (accessToken) {
                initializePlayer(accessToken);
            }
        };

        // Bot√≥n de login
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const codeVerifier = generateRandomString(64);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            localStorage.setItem('code_verifier', codeVerifier);

            const scope = 'streaming user-read-email user-read-private';
            const authUrl = new URL('https://accounts.spotify.com/authorize');

            const params = {
                response_type: 'code',
                client_id: CLIENT_ID,
                scope: scope,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge,
                redirect_uri: REDIRECT_URI,
            };

            authUrl.search = new URLSearchParams(params).toString();
            window.location.href = authUrl.toString();
        });

        // Intercambiar c√≥digo por token
        async function exchangeCodeForToken(code) {
            const codeVerifier = localStorage.getItem('code_verifier');

            const payload = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    client_id: CLIENT_ID,
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    code_verifier: codeVerifier,
                }),
            };

            try {
                const response = await fetch('https://accounts.spotify.com/api/token', payload);
                const data = await response.json();
                
                if (data.access_token) {
                    localStorage.removeItem('code_verifier');
                    accessToken = data.access_token;
                    
                    // Limpiar URL
                    window.history.replaceState({}, document.title, REDIRECT_URI);
                    
                    // Ocultar bot√≥n de login
                    document.getElementById('loginBtn').style.display = 'none';
                    
                    // Inicializar player
                    if (window.Spotify) {
                        initializePlayer(accessToken);
                    }
                }
            } catch (error) {
                showStatus('‚ùå Error al autenticar: ' + error.message);
            }
        }

        function showStatus(message) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
        }

        function initializePlayer(token) {
            showStatus('üéµ Conectando con Spotify...');
            document.getElementById('loginBtn').style.display = 'none';

            player = new Spotify.Player({
                name: 'Descubre la Canci√≥n',
                getOAuthToken: cb => { cb(token); },
                volume: 0.8
            });

            // Error handling
            player.addListener('initialization_error', ({ message }) => {
                showStatus('‚ùå Error de inicializaci√≥n: ' + message);
            });

            player.addListener('authentication_error', ({ message }) => {
                showStatus('‚ùå Error de autenticaci√≥n: ' + message);
            });

            player.addListener('account_error', ({ message }) => {
                showStatus('‚ùå Se requiere Spotify Premium');
            });

            // Ready
            player.addListener('ready', ({ device_id }) => {
                deviceId = device_id;
                showStatus('‚úÖ Listo! Dale al play para empezar');
                document.getElementById('content').classList.add('show');
                setupControls(token);
            });

            // Player state changed
            player.addListener('player_state_changed', (state) => {
                if (!state) return;

                const track = state.track_window.current_track;
                duration = state.duration;
                currentPosition = state.position;

                // Actualizar UI
                document.getElementById('albumArt').src = track.album.images[0].url;
                document.getElementById('albumArt').classList.add('show');
                document.getElementById('trackName').textContent = track.name;
                document.getElementById('trackArtist').textContent = track.artists[0].name;
                document.getElementById('trackInfo').classList.add('show');
                document.getElementById('progressContainer').classList.add('show');
                document.getElementById('duration').textContent = formatTime(duration);

                isPlaying = !state.paused;
                document.getElementById('playBtn').textContent = isPlaying ? '‚è∏' : '‚ñ∂';

                // Mostrar letras despu√©s de 3 segundos de reproducci√≥n
                if (isPlaying && !lyricsShown) {
                    setTimeout(() => {
                        if (!lyricsShown) {
                            lyricsShown = true;
                            document.getElementById('lyricsBox').classList.add('show');
                            document.getElementById('status').style.display = 'none';
                        }
                    }, 1000); // 3 segundos despu√©s de dar al play
                }

                // Actualizar barra de progreso
                if (isPlaying) {
                    startPositionTracking();
                } else {
                    stopPositionTracking();
                }

                updateProgressBar();
            });

            player.connect();
        }

        let hasStartedPlaying = false;

        function setupControls(token) {
            document.getElementById('playBtn').addEventListener('click', () => {
                if (!deviceId) return;
                
                if (isPlaying) {
                    player.pause();
                } else {
                    // Solo hacer el fetch la primera vez para cargar la canci√≥n
                    if (!hasStartedPlaying) {
                        hasStartedPlaying = true;
                        fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                uris: [TRACK_URI]
                            })
                        });
                    } else {
                        // Si ya ha empezado, solo reanudar
                        player.resume();
                    }
                }
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                player.nextTrack();
            });

            document.getElementById('prevBtn').addEventListener('click', () => {
                player.previousTrack();
            });

            // Click en barra de progreso
            document.getElementById('progressBar').addEventListener('click', (e) => {
                const rect = e.target.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const seekPosition = Math.floor(duration * percent);
                player.seek(seekPosition);
            });
        }

        function startPositionTracking() {
            stopPositionTracking();
            positionInterval = setInterval(() => {
                currentPosition += 1000;
                if (currentPosition > duration) currentPosition = duration;
                updateProgressBar();
            }, 1000);
        }

        function stopPositionTracking() {
            if (positionInterval) {
                clearInterval(positionInterval);
                positionInterval = null;
            }
        }

        function updateProgressBar() {
            const percent = (currentPosition / duration) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('currentTime').textContent = formatTime(currentPosition);
        }

        // Comprobar si hay c√≥digo en la URL al cargar
        const urlParams = getUrlParams();
        if (urlParams.code) {
            exchangeCodeForToken(urlParams.code);
        } else if (urlParams.error) {
            showStatus('‚ùå Error de autenticaci√≥n');
        }
    </script>
</body>
</html>
